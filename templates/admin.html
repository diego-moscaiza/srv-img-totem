<!DOCTYPE html>
<html>
<head>
    <title>Admin - Gesti√≥n de Productos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f6f7fb;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(60, 72, 88, 0.12);
            overflow: hidden;
        }
        /* Header */
        .header {
            background: #f6f7fb;
            color: #2d2d2d;
            padding: 40px 30px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        .header h1 { font-size: 2.5em; font-weight: 600; margin-bottom: 10px; }
        .header p { opacity: 0.8; font-size: 1.1em; }
        /* Contenido */
        .content { padding: 30px; }
        /* Navegaci√≥n */
        .nav {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            background: #f3f4f8;
            border-radius: 12px;
            padding: 5px;
            border: 1px solid #e0e0e0;
        }
        .nav button {
            flex: 1;
            background: transparent;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #444;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        .nav button:hover {
            background: #e6eaff;
            color: #2d5be3;
        }
        .nav button.active {
            background: #2d5be3;
            color: #fff;
            box-shadow: 0 2px 8px rgba(45, 91, 227, 0.10);
        }
        /* Secciones */
        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        .section.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        h2 {
            color: #2d5be3;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #222;
            font-weight: 600;
            font-size: 0.85em;
        }
        input, textarea, select {
            width: 100%;
            padding: 9px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #f9fafd;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #2d5be3;
            box-shadow: 0 0 0 2px #e6eaff;
            background: #fff;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px;
        }
        /* Layout de 2 columnas: carrusel + formulario */
        .crear-container {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
            align-items: start;
        }
        .carrusel-section {
            position: sticky;
            top: 20px;
        }
        .formulario-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            max-height: calc(100vh - 250px);
        }
        #crearForm {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        /* Secciones de formulario con t√≠tulo */
        .form-section {
            background: #f9fafd;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #606366;
            flex-shrink: 0;
        }
        .form-section h4 {
            color: #2d5be3;
            font-size: 0.8em;
            font-weight: 700;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-section .grid {
            grid-template-columns: 1fr 1fr;
        }
        .form-section .grid.full {
            grid-template-columns: 1fr;
        }
        /* Modal layout mejorado */
        .modal-content {
            background: #fff;
            margin: 3% auto;
            padding: 25px;
            border-radius: 15px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            box-shadow: 0 8px 32px rgba(60, 72, 88, 0.12);
            animation: modalSlide 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .modal-body {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 25px;
            align-items: start;
            overflow: hidden;
            flex: 1;
        }
        .modal-body.full {
            grid-template-columns: 1fr;
        }
        /* Botones */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        button {
            background: #2d5be3;
            color: #fff;
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(45, 91, 227, 0.10);
        }
        button:hover {
            background: #1a3e8a;
            box-shadow: 0 4px 16px rgba(45, 91, 227, 0.13);
        }
        button:active { transform: translateY(0); }
        button.danger {
            background: #f5576c;
            box-shadow: 0 2px 8px rgba(245, 87, 108, 0.10);
        }
        button.danger:hover {
            background: #c82333;
            box-shadow: 0 4px 16px rgba(245, 87, 108, 0.13);
        }
        /* Tabla */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            background: #fff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f3f4f8;
            color: #2d5be3;
            font-weight: 600;
            font-size: 0.95em;
        }
        tr:hover {
            background: #f6f7fb;
        }
        .actions {
            white-space: nowrap;
            display: flex;
            gap: 8px;
        }
        .actions button {
            margin-right: 0;
            padding: 8px 12px;
            font-size: 12px;
        }
        /* Alertas */
        #alertContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .alert-success {
            background: #eafaf1;
            color: #1e5d1e;
            border-left-color: #28a745;
        }
        .alert-error {
            background: #fce7e7;
            color: #721c24;
            border-left-color: #f5576c;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.12);
            backdrop-filter: blur(2px);
            overflow: hidden;
        }
        .modal.show { display: block; }
        .modal-content {
            background: #fff;
            margin: 3% auto;
            padding: 25px;
            border-radius: 15px;
            width: 95%;
            max-width: 1200px;
            max-height: 94vh;
            box-shadow: 0 8px 32px rgba(60, 72, 88, 0.12);
            animation: modalSlide 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close {
            color: #999;
            position: absolute;
            right: 25px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .close:hover {
            color: #2d5be3;
        }
        .reload-btn {
            margin-bottom: 15px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .empty-state p { font-size: 1.1em; }
        
        /* Filtros */
        .filtros-container {
            background: #f9fafd;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .filtro-grupo {
            display: flex;
            flex-direction: column;
        }
        .filtro-grupo label {
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .filtro-grupo select {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .btn-filtrar {
            padding: 10px 20px;
            margin: 0;
        }
        .btn-limpiar {
            background: #6c757d;
            padding: 10px 20px;
            margin: 0;
        }
        .btn-limpiar:hover {
            background: #5a6268;
        }
        
        /* Galer√≠a de productos */
        .productos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .producto-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .producto-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .producto-imagen {
            width: 100%;
            height: 180px;
            background: #f9fafd;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .producto-imagen img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .producto-info {
            padding: 15px;
        }
        .producto-codigo {
            font-weight: 600;
            color: #2d5be3;
            font-size: 0.9em;
        }
        .producto-nombre {
            font-weight: 600;
            color: #222;
            margin: 8px 0;
            font-size: 0.95em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
        }
        .producto-precio {
            color: #2d5be3;
            font-weight: 700;
            font-size: 1.1em;
            margin: 8px 0;
        }
        .producto-meta {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .producto-badge {
            font-size: 0.75em;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .producto-acciones {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .producto-acciones button {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
            margin: 0;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .crear-container {
                grid-template-columns: 1fr;
            }
            .carrusel-section {
                position: static;
                max-width: 100%;
            }
            .modal-body {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .form-section .grid {
                grid-template-columns: 1fr;
            }
            .productos-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            .modal-content {
                width: 98%;
                padding: 15px;
                margin: 10% auto;
            }
            h2 {
                font-size: 1.4em;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è Panel de Administraci√≥n</h1>
            <p>Gesti√≥n moderna de productos y cat√°logos</p>
        </div>
        
        <div class="content">
        
        <div id="alertContainer"></div>
        
        <!-- Navegaci√≥n -->
        <div class="nav">
            <button class="nav-btn active" onclick="mostrarSeccion('crear')">‚ûï Crear Producto</button>
            <button class="nav-btn" onclick="mostrarSeccion('listar')">üìã Productos Registrados</button>
        </div>
        
        <!-- Secci√≥n: Crear Producto -->
        <div id="crear" class="section active">
            <h2>‚ûï Crear Nuevo Producto</h2>
            
            <div class="crear-container">
                <!-- COLUMNA IZQUIERDA: Carrusel -->
                <div class="carrusel-section">
                    <h3 style="color: #2d5be3; margin-bottom: 12px; font-size: 1em; font-weight: 600;">üì∏ Vista Previa</h3>
                    <div style="position: relative; width: 100%; background: #f9fafd; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        
                        <!-- Contenedor del slider -->
                        <div id="crear-imagen-slider" style="position: relative; width: 100%; padding-bottom: 100%; background: #f9fafd;">
                            <div class="slide" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 1; transition: opacity 0.3s ease; background: #f9fafd; color: #999; font-size: 0.95em;">Seleccione imagen</div>
                            <div class="slide" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; background: #f9fafd; color: #999; font-size: 0.95em;">Seleccione imagen</div>
                        </div>
                        
                        <!-- Botones de navegaci√≥n -->
                        <button type="button" class="slide-prev" style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%); background: rgba(45, 91, 227, 0.8); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; z-index: 10; transition: background 0.3s ease;">‚Äπ</button>
                        <button type="button" class="slide-next" style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); background: rgba(45, 91, 227, 0.8); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; z-index: 10; transition: background 0.3s ease;">‚Ä∫</button>
                        
                        <!-- Indicadores de slide -->
                        <div style="position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 10;">
                            <div class="slide-indicator active" style="width: 8px; height: 8px; border-radius: 50%; background: #2d5be3; cursor: pointer; transition: all 0.3s ease;"></div>
                            <div class="slide-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: rgba(45, 91, 227, 0.4); cursor: pointer; transition: all 0.3s ease;"></div>
                        </div>
                        
                    </div>
                    
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <span style="padding: 4px 10px; background: #e6eaff; color: #2d5be3; border-radius: 16px; font-size: 0.85em; font-weight: 600;">üì∏ Listado</span>
                            <span style="padding: 4px 10px; background: #e6eaff; color: #2d5be3; border-radius: 16px; font-size: 0.85em; font-weight: 600;">üì∏ Detalles</span>
                        </div>
                    </div>
                </div>
                
                <!-- COLUMNA DERECHA: Formulario -->
                <div class="formulario-section">
                    <form id="crearForm">
                        <!-- Secci√≥n: Informaci√≥n B√°sica -->
                        <div class="form-section">
                            <h4>üìã Informaci√≥n B√°sica</h4>
                            <div class="grid">
                                <div class="form-group">
                                    <label>C√≥digo *</label>
                                    <input type="text" name="codigo" required placeholder="CELCEL0091">
                                </div>
                                <div class="form-group">
                                    <label>Nombre *</label>
                                    <input type="text" name="nombre" required placeholder="SAMSUNG GALAXY A06">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Descripci√≥n</label>
                                <textarea name="descripcion" placeholder="128 GB - 4 GB RAM" style="min-height: 80px;"></textarea>
                            </div>
                        </div>
                        
                        <!-- Secci√≥n: Precio y Categor√≠a -->
                        <div class="form-section">
                            <h4>üí∞ Precio y Categor√≠a</h4>
                            <div class="grid">
                                <div class="form-group">
                                    <label>Precio *</label>
                                    <input type="number" name="precio" step="0.01" required placeholder="949.00">
                                </div>
                                <div class="form-group">
                                    <label>Categor√≠a *</label>
                                    <select name="categoria" required>
                                        <option value="">Seleccionar...</option>
                                        <option>celulares</option>
                                        <option>laptops</option>
                                        <option>televisores</option>
                                        <option>refrigeradoras</option>
                                        <option>lavadoras</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Secci√≥n: Clasificaci√≥n -->
                        <div class="form-section">
                            <h4>üè∑Ô∏è Clasificaci√≥n</h4>
                            <div class="grid">
                                <div class="form-group">
                                    <label>Segmento *</label>
                                    <select name="segmento" required>
                                        <option value="fnb">FNB</option>
                                        <option value="gaso">GASO</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Estado *</label>
                                    <select name="estado" required>
                                        <option value="disponible">Disponible</option>
                                        <option value="no disponible">No Disponible</option>
                                        <option value="agotado">Agotado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid">
                                <div class="form-group">
                                    <label>Mes *</label>
                                    <select name="mes" required>
                                        <option value="">Seleccionar...</option>
                                        <option>enero</option><option>febrero</option><option>marzo</option><option>abril</option>
                                        <option>mayo</option><option>junio</option><option>julio</option><option>agosto</option>
                                        <option>septiembre</option><option>octubre</option><option>noviembre</option><option>diciembre</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>A√±o *</label>
                                    <select name="ano" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Secci√≥n: Im√°genes -->
                        <div class="form-section">
                            <h4>üñºÔ∏è Im√°genes</h4>
                            <div class="form-group">
                                <label>Imagen Listado *</label>
                                <select name="imagen_listado" required>
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Imagen Caracter√≠sticas *</label>
                                <select name="imagen_caracteristicas" required>
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Secci√≥n: Cuotas -->
                        <div class="form-section">
                            <h4>üìä Cuotas (JSON) *</h4>
                            <div class="form-group">
                                <textarea name="cuotas" required placeholder='{"3": 338.85, "6": 178.87, "9": 125.7, "12": 99.24}' style="min-height: 120px; font-family: 'Courier New', monospace; font-size: 0.9em;"></textarea>
                            </div>
                        </div>
                        
                        <!-- Botones -->
                        <div class="btn-group" style="margin-top: 15px;">
                            <button type="submit">‚úÖ Crear Producto</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Secci√≥n: Productos Registrados -->
        <div id="listar" class="section">
            <h2>üìã Productos Registrados</h2>
            <button class="reload-btn" onclick="cargarProductos()">üîÑ Recargar</button>
            
            <!-- Filtros -->
            <div class="filtros-container">
                <div class="filtros-grid">
                    <div class="filtro-grupo">
                        <label>Segmento</label>
                        <select id="filtroSegmento" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="fnb">FNB</option>
                            <option value="gaso">GASO</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <label>A√±o</label>
                        <select id="filtroAnio" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <label>Mes</label>
                        <select id="filtroMes" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="noviembre">Noviembre</option>
                            <option value="diciembre">Diciembre</option>
                            <option value="enero">Enero</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <label>Categor√≠a</label>
                        <select id="filtroCategoria" onchange="aplicarFiltros()">
                            <option value="">Todas</option>
                            <option value="celulares">Celulares</option>
                            <option value="laptops">Laptops</option>
                            <option value="televisores">Televisores</option>
                            <option value="refrigeradoras">Refrigeradoras</option>
                            <option value="lavadoras">Lavadoras</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <label>Estado</label>
                        <select id="filtroEstado" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="disponible">Disponible</option>
                            <option value="no disponible">No Disponible</option>
                            <option value="agotado">Agotado</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <label>Ordenar por Precio</label>
                        <select id="filtroOrden" onchange="aplicarFiltros()">
                            <option value="">Sin Ordenar</option>
                            <option value="menor">Menor a Mayor</option>
                            <option value="mayor">Mayor a Menor</option>
                        </select>
                    </div>
                </div>
                <div class="actualizar-filtro-grupo" style="display: flex; gap: 10px;">
                    <button class="btn-filtrar" onclick="aplicarFiltros()">üîç Filtrar</button>
                    <button class="btn-limpiar" onclick="limpiarFiltros()">‚ú® Limpiar</button>
                </div>
            </div>
            
            <div id="productosGaleria" class="productos-grid">
            </div>
        </div>
    </div>

    <!-- Modal para editar -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h2>‚úèÔ∏è Editar Producto</h2>
            <form id="editForm">
                <div class="grid" id="editFormFields"></div>
                <div class="btn-group">
                    <button type="submit">üíæ Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let productoEnEdicion = null;
        let productosGlobal = [];
        let imagenesDisponibles = { listado: {}, caracteristicas: {} };

        // Cargar im√°genes disponibles con filtros - MEJORADO
        async function cargarImagenesDisponibles(segmento = null, ano = null, mes = null, categoria = null) {
            try {
                const params = new URLSearchParams();
                
                // Normalizar par√°metros
                if (segmento && String(segmento).trim() !== '') {
                    const segmentoLimpio = String(segmento).trim().toLowerCase();
                    params.append('segmento', segmentoLimpio);
                }
                if (ano && String(ano).trim() !== '') {
                    params.append('ano', String(ano).trim());
                }
                if (mes && String(mes).trim() !== '') {
                    const mesLimpio = String(mes).trim().toLowerCase();
                    params.append('mes', mesLimpio);
                }
                // NO PASAR CATEGOR√çA EN EL ENDPOINT - se filtrar√° manualmente en actualizarSelectImagenes
                
                const url = '/api/imagenes-disponibles' + (params.toString() ? '?' + params.toString() : '');
                console.log('üì° Consultando endpoint:', url);
                console.log('   Par√°metros: { segmento:', segmento, ', a√±o:', ano, ', mes:', mes, ', categor√≠a:', categoria, '(filtro manual) }');
                
                const response = await fetch(url);
                if (response.ok) {
                    imagenesDisponibles = await response.json();
                    console.log('‚úÖ Respuesta recibida con', 
                        Object.keys(imagenesDisponibles.listado || {}).length, 'claves de listado y',
                        Object.keys(imagenesDisponibles.caracteristicas || {}).length, 'claves de caracter√≠sticas');
                    // ‚úÖ LLAMAR AQU√ç para sincronizar - el dropdown se actualiza DESPU√âS de cargar datos
                    actualizarSelectImagenes();
                } else {
                    console.error('‚ùå Error en respuesta del servidor:', response.status);
                    mostrarAlerta('‚ö†Ô∏è Error al cargar im√°genes disponibles', 'error');
                }
            } catch(e) {
                console.error('‚ùå Error cargando im√°genes:', e);
                mostrarAlerta('‚ö†Ô∏è Error de conexi√≥n al cargar im√°genes: ' + e.message, 'error');
            }
        }

        // NOTA: Los listeners se configuran en inicializarCarruselCrear para evitar duplicados
        // y garantizar sincronizaci√≥n correcta de actualizaciones

        // Actualizar select de im√°genes - MEJORADO
        function actualizarSelectImagenes() {
            // üéØ BUSCAR ESPEC√çFICAMENTE EN EL FORMULARIO DE CREAR
            const crearForm = document.getElementById('crearForm');
            if (!crearForm) {
                console.error('‚ùå actualizarSelectImagenes: No se encontr√≥ crearForm');
                return;
            }
            
            const selectListado = crearForm.querySelector('select[name="imagen_listado"]');
            const selectCaracteristicas = crearForm.querySelector('select[name="imagen_caracteristicas"]');
            const selectCategoria = crearForm.querySelector('select[name="categoria"]');
            
            // Obtener la categor√≠a seleccionada (puede ser vac√≠o)
            const categoriaSeleccionada = selectCategoria?.value?.toLowerCase().trim() || null;
            
            console.log('üñºÔ∏è [CREAR] Actualizando select de im√°genes');
            console.log('   Categor√≠a seleccionada:', categoriaSeleccionada);
            console.log('   Estructura de imagenesDisponibles:', {
                'listado': Object.keys(imagenesDisponibles.listado || {}).length + ' claves',
                'caracteristicas': Object.keys(imagenesDisponibles.caracteristicas || {}).length + ' claves'
            });
            
            if (selectListado && imagenesDisponibles.listado) {
                let options = '<option value="">Seleccionar...</option>';
                let imagenesEncontradas = 0;
                
                // Debug: mostrar todas las claves
                const todasLasClaves = Object.entries(imagenesDisponibles.listado);
                console.log('   üìã Claves de listado:', todasLasClaves.map(([k, v]) => `${k} (${v.length} imgs)`));
                
                for (const [key, imagenes] of todasLasClaves) {
                    // Si hay categor√≠a seleccionada, filtrar por ella
                    if (categoriaSeleccionada) {
                        const partes = key.split('/');
                        const categoriaCarpeta = partes[partes.length - 1]; // "1-celulares"
                        const categoriaClave = categoriaCarpeta.split('-').slice(1).join('-').toLowerCase(); // "celulares"
                        
                        // Solo incluir si coincide la categor√≠a
                        if (categoriaClave !== categoriaSeleccionada) {
                            continue;
                        }
                    }
                    
                    // Mostrar todas las im√°genes de este directorio
                    imagenes.forEach(img => {
                        options += `<option value="${img.url}">${key} - ${img.nombre}</option>`;
                        imagenesEncontradas++;
                    });
                }
                
                console.log(`‚úÖ [CREAR] Im√°genes de listado encontradas: ${imagenesEncontradas}`);
                selectListado.innerHTML = options;
            } else {
                console.warn('‚ö†Ô∏è [CREAR] selectListado no encontrado o imagenesDisponibles.listado vac√≠o');
            }
            
            if (selectCaracteristicas && imagenesDisponibles.caracteristicas) {
                let options = '<option value="">Seleccionar...</option>';
                let imagenesEncontradas = 0;
                
                // Debug: mostrar todas las claves
                const todasLasClaves = Object.entries(imagenesDisponibles.caracteristicas);
                console.log('   üìã Claves de caracter√≠sticas:', todasLasClaves.map(([k, v]) => `${k} (${v.length} imgs)`));
                
                for (const [key, imagenes] of todasLasClaves) {
                    // Si hay categor√≠a seleccionada, filtrar por ella
                    if (categoriaSeleccionada) {
                        const partes = key.split('/');
                        const categoriaCarpeta = partes[partes.length - 1];
                        const categoriaClave = categoriaCarpeta.split('-').slice(1).join('-').toLowerCase();
                        
                        // Solo incluir si coincide la categor√≠a
                        if (categoriaClave !== categoriaSeleccionada) {
                            continue;
                        }
                    }
                    
                    // Mostrar todas las im√°genes de este directorio
                    imagenes.forEach(img => {
                        options += `<option value="${img.url}">${key} - ${img.nombre}</option>`;
                        imagenesEncontradas++;
                    });
                }
                
                console.log(`‚úÖ [CREAR] Im√°genes de caracter√≠sticas encontradas: ${imagenesEncontradas}`);
                selectCaracteristicas.innerHTML = options;
            } else {
                console.warn('‚ö†Ô∏è [CREAR] selectCaracteristicas no encontrado o imagenesDisponibles.caracteristicas vac√≠o');
            }
        }

        // Alternar secciones
        // Flag para evitar duplicar listeners
        let listenersCrearConfigurados = false;
        
        function mostrarSeccion(seccion) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            const sectionEl = document.getElementById(seccion);
            if (sectionEl) {
                sectionEl.classList.add('active');
            }
            
            const botones = document.querySelectorAll('.nav-btn');
            botones.forEach((btn, idx) => {
                if ((seccion === 'crear' && idx === 0) || (seccion === 'listar' && idx === 1)) {
                    btn.classList.add('active');
                }
            });
            
            if (seccion === 'crear') {
                setTimeout(async () => {
                    // Leer valores actuales de los selects
                    const crearForm = document.getElementById('crearForm');
                    const seg = crearForm?.querySelector('select[name="segmento"]')?.value || 'fnb';
                    const an = crearForm?.querySelector('select[name="ano"]')?.value || '2025';
                    const m = crearForm?.querySelector('select[name="mes"]')?.value || 'noviembre';
                    
                    console.log('üìå mostrarSeccion(crear): Cargando im√°genes con:', { seg, an, m });
                    await cargarImagenesDisponibles(seg, an, m);
                    inicializarCarruselCrear();
                }, 100);
            } else if (seccion === 'listar') {
                setTimeout(() => {
                    cargarProductos();
                }, 100);
            }
        }
        
        function inicializarCarruselCrear() {
            const container = document.getElementById('crear-imagen-slider').parentElement;
            inicializarSlider(container);
            
            // üõë EVITAR DUPLICAR LISTENERS
            if (listenersCrearConfigurados) {
                console.log('‚ö†Ô∏è [CREAR] Listeners ya configurados, saltando...');
                return;
            }
            
            // üéØ BUSCAR SELECTORES ESPEC√çFICAMENTE EN EL FORMULARIO DE CREAR
            const crearForm = document.getElementById('crearForm');
            if (!crearForm) {
                console.error('‚ùå No se encontr√≥ el formulario crearForm');
                return;
            }
            
            // Event listeners para filtros de im√°genes - MEJORADO
            const selectSegmento = crearForm.querySelector('select[name="segmento"]');
            const selectAno = crearForm.querySelector('select[name="ano"]');
            const selectMes = crearForm.querySelector('select[name="mes"]');
            const selectCategoria = crearForm.querySelector('select[name="categoria"]');
            
            console.log('üìå [CREAR] Selectores encontrados:', {
                segmento: !!selectSegmento,
                ano: !!selectAno,
                mes: !!selectMes,
                categoria: !!selectCategoria
            });
            
            const actualizarImagenesFiltro = async () => {
                const seg = selectSegmento ? selectSegmento.value : null;
                const an = selectAno ? selectAno.value : null;
                const m = selectMes ? selectMes.value : null;
                
                console.log('üîÑ [CREAR] Cambio de filtro seg/a√±o/mes detectado:', { seg, an, m });
                
                // Solo hacer request si hay al menos segmento, a√±o y mes
                if (seg && an && m) {
                    await cargarImagenesDisponibles(seg, an, m);
                } else {
                    console.log('‚ö†Ô∏è [CREAR] Esperando que se completen seg/a√±o/mes');
                }
            };
            
            // Agregar listeners a filtros seg/a√±o/mes
            if (selectSegmento) selectSegmento.addEventListener('change', actualizarImagenesFiltro);
            if (selectAno) selectAno.addEventListener('change', actualizarImagenesFiltro);
            if (selectMes) selectMes.addEventListener('change', actualizarImagenesFiltro);
            
            // Listener SEPARADO para cambios de categor√≠a - solo actualiza select, sin cargar endpoint
            if (selectCategoria) {
                selectCategoria.addEventListener('change', () => {
                    console.log('üîÑ [CREAR] Categor√≠a cambi√≥, actualizando dropdown...');
                    actualizarSelectImagenes(); // Solo filtra, no carga del endpoint
                });
            }
            
            console.log('‚úÖ [CREAR] Listeners de im√°genes configurados');
            
            // üîí Marcar que los listeners ya fueron configurados
            listenersCrearConfigurados = true;
            
            // Event listeners para actualizar carrusel en tiempo real
            const selectListado = crearForm.querySelector('select[name="imagen_listado"]');
            const selectCaracteristicas = crearForm.querySelector('select[name="imagen_caracteristicas"]');
            const sliderContainer = document.getElementById('crear-imagen-slider');
            const slides = sliderContainer.querySelectorAll('.slide');
            
            if (selectListado && slides.length > 0) {
                selectListado.addEventListener('change', (e) => {
                    if (e.target.value.trim() !== '') {
                        const imgSlide = slides[0];
                        imgSlide.innerHTML = `<img src="${e.target.value}" style="width: 100%; height: 100%; object-fit: contain; display: block;">`;
                        imgSlide.style.color = 'transparent';
                    } else {
                        slides[0].innerHTML = 'Seleccione imagen de listado';
                        slides[0].style.color = '#999';
                    }
                });
            }
            
            if (selectCaracteristicas && slides.length > 1) {
                selectCaracteristicas.addEventListener('change', (e) => {
                    if (e.target.value.trim() !== '') {
                        const imgSlide = slides[1];
                        imgSlide.innerHTML = `<img src="${e.target.value}" style="width: 100%; height: 100%; object-fit: contain; display: block;">`;
                        imgSlide.style.color = 'transparent';
                    } else {
                        slides[1].innerHTML = 'Seleccione imagen de caracter√≠sticas';
                        slides[1].style.color = '#999';
                    }
                });
            }
        }

        document.getElementById('crearForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await crearProducto();
        });

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await guardarEdicion();
        });

        async function crearProducto() {
            try {
                const formData = new FormData(document.getElementById('crearForm'));
                const cuotas = JSON.parse(formData.get('cuotas'));
                
                const data = {
                    codigo: formData.get('codigo'),
                    nombre: formData.get('nombre'),
                    descripcion: formData.get('descripcion'),
                    precio: parseFloat(formData.get('precio')),
                    categoria: formData.get('categoria'),
                    imagen_listado: formData.get('imagen_listado'),
                    imagen_caracteristicas: formData.get('imagen_caracteristicas'),
                    cuotas: cuotas,
                    mes: formData.get('mes'),
                    ano: parseInt(formData.get('ano')),
                    segmento: formData.get('segmento'),
                    estado: formData.get('estado'),
                    stock: formData.get('stock') === 'true'
                };

                const response = await fetch('/api/productos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    mostrarAlerta('‚úÖ Producto creado exitosamente', 'success');
                    document.getElementById('crearForm').reset();
                    setTimeout(() => {
                        mostrarSeccion('listar');
                    }, 1500);
                } else {
                    const error = await response.json();
                    mostrarAlerta('‚ùå Error: ' + (error.detail || 'Error desconocido'), 'error');
                }
            } catch(e) {
                mostrarAlerta('‚ùå Error: ' + e.message, 'error');
            }
        }

        async function cargarProductos() {
            try {
                const response = await fetch('/api/productos');
                if (!response.ok) {
                    mostrarAlerta('‚ùå Error al obtener productos', 'error');
                    return;
                }
                const productos = await response.json();
                productosGlobal = productos;
                mostrarProductos(productos);
            } catch(e) {
                console.error('Error en cargarProductos:', e);
                mostrarAlerta('‚ùå Error: ' + e.message, 'error');
            }
        }

        function aplicarFiltros() {
            const segmento = document.getElementById('filtroSegmento').value;
            const anio = document.getElementById('filtroAnio').value;
            const mes = document.getElementById('filtroMes').value;
            const categoria = document.getElementById('filtroCategoria').value;
            const estado = document.getElementById('filtroEstado').value;
            const orden = document.getElementById('filtroOrden').value;

            let productosFiltrados = productosGlobal;

            if (segmento) {
                productosFiltrados = productosFiltrados.filter(p => p.segmento === segmento);
            }
            if (anio) {
                productosFiltrados = productosFiltrados.filter(p => p.ano === parseInt(anio));
            }
            if (mes) {
                productosFiltrados = productosFiltrados.filter(p => p.mes.toLowerCase() === mes.toLowerCase());
            }
            if (categoria) {
                productosFiltrados = productosFiltrados.filter(p => p.categoria.toLowerCase() === categoria.toLowerCase());
            }
            if (estado) {
                productosFiltrados = productosFiltrados.filter(p => p.estado === estado);
            }

            if (orden === 'menor') {
                productosFiltrados.sort((a, b) => a.precio - b.precio);
            } else if (orden === 'mayor') {
                productosFiltrados.sort((a, b) => b.precio - a.precio);
            }

            mostrarProductos(productosFiltrados);
        }

        function limpiarFiltros() {
            document.getElementById('filtroSegmento').value = '';
            document.getElementById('filtroAnio').value = '';
            document.getElementById('filtroMes').value = '';
            document.getElementById('filtroCategoria').value = '';
            document.getElementById('filtroEstado').value = '';
            document.getElementById('filtroOrden').value = '';
            mostrarProductos(productosGlobal);
        }

        function mostrarProductos(productos) {
            const galeria = document.getElementById('productosGaleria');
            if (!galeria) {
                console.error('No se encontr√≥ elemento productosGaleria');
                return;
            }
            galeria.innerHTML = '';
            
            if (!productos || productos.length === 0) {
                galeria.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">üì≠ No hay productos registrados</div>';
                return;
            }
            
            productos.forEach(p => {
                try {
                    const estadoColor = p.estado === 'disponible' ? '#d4edda' : '#fce7e7';
                    const estadoTextColor = p.estado === 'disponible' ? '#1e5d1e' : '#721c24';
                    const segmentoColor = p.segmento === 'fnb' ? '#cfe2ff' : '#fff3cd';
                    const segmentoTextColor = p.segmento === 'fnb' ? '#084298' : '#664d03';
                    
                    const imagenUrl = p.imagen_listado ? p.imagen_listado : '';
                    
                    const card = document.createElement('div');
                    card.className = 'producto-card';
                    card.innerHTML = `
                        <div class="producto-imagen" id="img-${p.id}">
                            ${imagenUrl ? `<img src="${imagenUrl}" alt="${p.nombre}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px; border: 1px solid #e0e0e0;">` : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; font-size: 0.9em; color: #999; border: 2px dashed #d0d0d0; border-radius: 8px;">Sin imagen</div>'}
                        </div>
                        <div class="producto-info">
                            <div class="producto-codigo">${p.codigo}</div>
                            <div class="producto-nombre">${p.nombre}</div>
                            <div class="producto-precio">S/. ${p.precio.toFixed(2)}</div>
                            <div class="producto-meta">
                                <span class="producto-badge" style="background: ${segmentoColor}; color: ${segmentoTextColor};">${p.segmento.toUpperCase()}</span>
                                <span class="producto-badge" style="background: ${estadoColor}; color: ${estadoTextColor};">${p.estado}</span>
                            </div>
                            <div class="producto-acciones">
                                <button onclick="abrirDetalle(${p.id})">üëÅÔ∏è Ver</button>
                                <button class="danger" onclick="eliminarProducto(${p.id})">üóëÔ∏è Eliminar</button>
                            </div>
                        </div>
                    `;
                    galeria.appendChild(card);
                    
                    if (imagenUrl) {
                        const img = card.querySelector('img');
                        if (img) {
                            img.onerror = function() {
                                const container = document.getElementById('img-' + p.id);
                                if (container) {
                                    container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; font-size: 0.9em; color: #999; border: 2px dashed #d0d0d0; border-radius: 8px;">Sin imagen</div>';
                                }
                            };
                        }
                    }
                } catch(e) {
                    console.error('Error procesando producto:', p, e);
                }
            });
        }

        async function abrirDetalle(id) {
            try {
                const response = await fetch('/api/productos/' + id);
                const producto = await response.json();
                productoEnEdicion = producto;
                
                // Crear modal con campos editables
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.id = 'detalleModal';
                modal.style.zIndex = '1100';
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                        <span class="close" onclick="document.getElementById('detalleModal').remove()">&times;</span>
                        <h2 style="display: flex; align-items: center; gap: 10px;">üëÅÔ∏è Detalle del Producto <span style="font-size: 0.7em; color: #999; font-weight: 400;">(Editable)</span></h2>
                        <div id="contenido-modal"></div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Cargar contenido con campos editables
                await cargarContenidoEditable(modal, producto);
                
            } catch(e) {
                mostrarAlerta('‚ùå Error: ' + e.message, 'error');
            }
        }
        
        async function cargarContenidoEditable(modal, producto) {
            // Construir HTML con layout de 2 columnas
            let html = '<div class="modal-body">';
            
            // COLUMNA IZQUIERDA: Carrusel
            html += '<div style="display: flex; flex-direction: column; gap: 15px;">';
            html += '<div style="position: relative; width: 100%; background: #f9fafd; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">';
            
            // Contenedor del slider
            html += '<div id="imagen-slider" style="position: relative; width: 100%; padding-bottom: 100%; background: #f9fafd;">';
            
            // Imagen Listado
            if (producto.imagen_listado && producto.imagen_listado.trim() !== '') {
                html += `<div class="slide" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 1; transition: opacity 0.3s ease;">
                            <img src="${producto.imagen_listado}" style="width: 100%; height: 100%; object-fit: contain; display: block;">
                        </div>`;
            } else {
                html += `<div class="slide" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 1; transition: opacity 0.3s ease; background: #f9fafd; color: #999; font-size: 0.9em;">Sin imagen</div>`;
            }
            
            // Imagen Caracter√≠sticas
            if (producto.imagen_caracteristicas && producto.imagen_caracteristicas.trim() !== '') {
                html += `<div class="slide" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease;">
                            <img src="${producto.imagen_caracteristicas}" style="width: 100%; height: 100%; object-fit: contain; display: block;">
                        </div>`;
            } else {
                html += `<div class="slide" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; background: #f9fafd; color: #999; font-size: 0.9em;">Sin imagen</div>`;
            }
            
            html += '</div>';
            
            // Botones de navegaci√≥n
            html += '<button class="slide-prev" style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%); background: rgba(45, 91, 227, 0.8); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; z-index: 10; transition: background 0.3s ease;">‚Äπ</button>';
            html += '<button class="slide-next" style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); background: rgba(45, 91, 227, 0.8); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; z-index: 10; transition: background 0.3s ease;">‚Ä∫</button>';
            
            // Indicadores de slide
            html += '<div style="position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 10;">';
            html += '<div class="slide-indicator active" style="width: 8px; height: 8px; border-radius: 50%; background: #2d5be3; cursor: pointer; transition: all 0.3s ease;"></div>';
            html += '<div class="slide-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: rgba(45, 91, 227, 0.4); cursor: pointer; transition: all 0.3s ease;"></div>';
            html += '</div>';
            html += '</div>';
            
            // Info de im√°genes
            html += '<div style="display: flex; gap: 8px; flex-wrap: wrap;">';
            html += '<span style="padding: 4px 10px; background: #e6eaff; color: #2d5be3; border-radius: 16px; font-size: 0.85em; font-weight: 600;">üì∏ Listado</span>';
            html += '<span style="padding: 4px 10px; background: #e6eaff; color: #2d5be3; border-radius: 16px; font-size: 0.85em; font-weight: 600;">üì∏ Detalles</span>';
            html += '</div>';
            html += '</div>';
            
            // COLUMNA DERECHA: Formulario
            html += '<div style="display: flex; flex-direction: column; gap: 15px; overflow-y: auto; max-height: 70vh;">';
            
            // Secci√≥n: Informaci√≥n B√°sica
            html += '<div class="form-section">';
            html += '<h4>üìã Informaci√≥n B√°sica</h4>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
            html += '<div class="form-group"><label style="margin-bottom: 6px;">C√≥digo</label><input type="text" name="codigo" value="' + producto.codigo + '"></div>';
            html += '<div class="form-group"><label style="margin-bottom: 6px;">Nombre</label><input type="text" name="nombre" value="' + producto.nombre + '"></div>';
            html += '</div>';
            html += '<div class="form-group"><label style="margin-bottom: 6px;">Descripci√≥n</label><textarea name="descripcion" style="min-height: 70px;">' + (producto.descripcion || '') + '</textarea></div>';
            html += '</div>';
            
            // Secci√≥n: Precio y Categor√≠a
            html += '<div class="form-section">';
            html += '<h4>üí∞ Precio y Categor√≠a</h4>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
            html += '<div class="form-group"><label style="margin-bottom: 6px;">Precio</label><input type="number" name="precio" value="' + producto.precio + '" step="0.01"></div>';
            html += '<div class="form-group"><label style="margin-bottom: 6px;">Categor√≠a</label><select name="categoria"><option>' + producto.categoria + '</option><option>celulares</option><option>laptops</option><option>televisores</option><option>refrigeradoras</option><option>lavadoras</option></select></div>';
            html += '</div>';
            html += '</div>';
            
            // Secci√≥n: Clasificaci√≥n
            html += '<div class="form-section">';
            html += '<h4>üè∑Ô∏è Clasificaci√≥n</h4>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
            html += '<div class="form-group"><label style="margin-bottom: 6px;">Segmento</label><select name="segmento"><option value="fnb" ' + (producto.segmento === 'fnb' ? 'selected' : '') + '>FNB</option><option value="gaso" ' + (producto.segmento === 'gaso' ? 'selected' : '') + '>GASO</option></select></div>';
            html += '<div class="form-group"><label style="margin-bottom: 6px;">Estado</label><select name="estado"><option value="disponible" ' + (producto.estado === 'disponible' ? 'selected' : '') + '>Disponible</option><option value="no disponible" ' + (producto.estado === 'no disponible' ? 'selected' : '') + '>No Disponible</option><option value="agotado" ' + (producto.estado === 'agotado' ? 'selected' : '') + '>Agotado</option></select></div>';
            html += '</div>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
            html += '<div class="form-group"><label style="margin-bottom: 6px;">Mes</label><select name="mes">';
            const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            meses.forEach(mes => {
                html += '<option value="' + mes + '" ' + (producto.mes === mes ? 'selected' : '') + '>' + mes.charAt(0).toUpperCase() + mes.slice(1) + '</option>';
            });
            html += '</select></div>';
            html += '<div class="form-group"><label style="margin-bottom: 6px;">A√±o</label><select name="ano"><option value="2024" ' + (producto.ano === 2024 ? 'selected' : '') + '>2024</option><option value="2025" ' + (producto.ano === 2025 ? 'selected' : '') + '>2025</option><option value="2026" ' + (producto.ano === 2026 ? 'selected' : '') + '>2026</option><option value="2027" ' + (producto.ano === 2027 ? 'selected' : '') + '>2027</option></select></div>';
            html += '</div>';
            html += '</div>';
            
            // Secci√≥n: Im√°genes
            html += '<div class="form-section">';
            html += '<h4>üñºÔ∏è Im√°genes</h4>';
            html += '<div class="form-group"><label style="margin-bottom: 6px;">Imagen Listado</label><select name="imagen_listado"><option value="' + producto.imagen_listado + '">' + producto.imagen_listado + '</option></select></div>';
            html += '<div class="form-group"><label style="margin-bottom: 6px;">Imagen Caracter√≠sticas</label><select name="imagen_caracteristicas"><option value="' + producto.imagen_caracteristicas + '">' + producto.imagen_caracteristicas + '</option></select></div>';
            html += '</div>';
            
            // Secci√≥n: Cuotas
            html += '<div class="form-section">';
            html += '<h4>üìä Cuotas (JSON)</h4>';
            html += '<div class="form-group"><textarea name="cuotas" style="min-height: 100px; font-family: \'Courier New\', monospace; font-size: 0.85em;">' + JSON.stringify(producto.cuotas, null, 2) + '</textarea></div>';
            html += '</div>';
            
            // Botones de acci√≥n
            html += '<div style="display: flex; gap: 10px; margin-top: 10px; border-top: 1px solid #e0e0e0; padding-top: 15px;">';
            html += '<button id="btn-guardar" type="button" style="flex: 1; padding: 10px; background: #2d5be3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95em;">üíæ Guardar</button>';
            html += '<button id="btn-eliminar-det" type="button" style="flex: 1; padding: 10px; background: #f5576c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95em;">üóëÔ∏è Eliminar</button>';
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
            
            modal.querySelector('#contenido-modal').innerHTML = html;
            
            // Cargar im√°genes din√°micamente
            const segmento = modal.querySelector('select[name="segmento"]').value;
            const ano = modal.querySelector('select[name="ano"]').value;
            const mes = modal.querySelector('select[name="mes"]').value;
            const categoria = modal.querySelector('select[name="categoria"]').value;
            // NO pasar categor√≠a al endpoint - se filtrar√° localmente
            await cargarImagenesDisponibles(segmento, ano, mes);
            
            // Actualizar selects de im√°genes
            actualizarSelectImagenesEnModal(modal);
            
            // Cargar im√°genes con la categor√≠a actual del producto
            const segmentoActual = modal.querySelector('select[name="segmento"]').value;
            const anoActual = modal.querySelector('select[name="ano"]').value;
            const mesActual = modal.querySelector('select[name="mes"]').value;
            // NO pasar categor√≠a al endpoint
            await cargarImagenesDisponibles(segmentoActual, anoActual, mesActual);
            actualizarSelectImagenesEnModal(modal);
            
            // Event listeners para filtros
            const filtros = modal.querySelectorAll('select[name="segmento"], select[name="ano"], select[name="mes"], select[name="categoria"]');
            filtros.forEach(filtro => {
                filtro.addEventListener('change', async () => {
                    const seg = modal.querySelector('select[name="segmento"]').value;
                    const an = modal.querySelector('select[name="ano"]').value;
                    const m = modal.querySelector('select[name="mes"]').value;
                    // NO pasar categor√≠a al endpoint - se filtrar√° localmente
                    await cargarImagenesDisponibles(seg, an, m);
                    actualizarSelectImagenesEnModal(modal);
                });
            });
            
            // Event listeners para actualizar carrusel en tiempo real
            const selectListado = modal.querySelector('select[name="imagen_listado"]');
            const selectCaracteristicas = modal.querySelector('select[name="imagen_caracteristicas"]');
            const slides = modal.querySelectorAll('.slide');
            
            if (selectListado && slides.length > 0) {
                selectListado.addEventListener('change', (e) => {
                    const imgSlide = slides[0].querySelector('img');
                    if (imgSlide) {
                        imgSlide.src = e.target.value;
                    }
                });
            }
            
            if (selectCaracteristicas && slides.length > 1) {
                selectCaracteristicas.addEventListener('change', (e) => {
                    const imgSlide = slides[1].querySelector('img');
                    if (imgSlide) {
                        imgSlide.src = e.target.value;
                    }
                });
            }
            
            // Botones de acci√≥n
            modal.querySelector('#btn-guardar').addEventListener('click', async () => {
                await guardarEdicionDesdeModal(modal);
            });
            
            modal.querySelector('#btn-eliminar-det').addEventListener('click', async () => {
                if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar este producto?')) {
                    await eliminarProducto(producto.id);
                    document.getElementById('detalleModal').remove();
                }
            });
            
            // Inicializar slider
            await new Promise(r => setTimeout(r, 0));
            inicializarSlider(modal);
        }
        
        function actualizarSelectImagenesEnModal(modal) {
            const selectListado = modal.querySelector('select[name="imagen_listado"]');
            const selectCaracteristicas = modal.querySelector('select[name="imagen_caracteristicas"]');
            const selectCategoria = modal.querySelector('select[name="categoria"]');
            
            // Obtener la categor√≠a seleccionada (puede ser vac√≠o)
            const categoriaSeleccionada = selectCategoria?.value?.toLowerCase().trim() || null;
            
            console.log('üñºÔ∏è Modal: Actualizando select de im√°genes');
            console.log('   Categor√≠a seleccionada:', categoriaSeleccionada);
            
            if (selectListado && imagenesDisponibles.listado) {
                let options = '<option value="' + (productoEnEdicion.imagen_listado || '') + '">' + (productoEnEdicion.imagen_listado || 'Seleccionar...') + '</option>';
                let imagenesEncontradas = 0;
                
                for (const [key, imagenes] of Object.entries(imagenesDisponibles.listado)) {
                    // Si hay categor√≠a seleccionada, filtrar por ella
                    if (categoriaSeleccionada) {
                        const partes = key.split('/');
                        const categoriaCarpeta = partes[partes.length - 1]; // "1-celulares"
                        const categoriaClave = categoriaCarpeta.split('-').slice(1).join('-').toLowerCase(); // "celulares"
                        
                        // Solo incluir si coincide la categor√≠a
                        if (categoriaClave !== categoriaSeleccionada) {
                            continue;
                        }
                    }
                    
                    imagenes.forEach(img => {
                        options += `<option value="${img.url}">${key} - ${img.nombre}</option>`;
                        imagenesEncontradas++;
                    });
                }
                
                console.log(`‚úÖ Modal - Im√°genes de listado encontradas: ${imagenesEncontradas}`);
                selectListado.innerHTML = options;
            }
            
            if (selectCaracteristicas && imagenesDisponibles.caracteristicas) {
                let options = '<option value="' + (productoEnEdicion.imagen_caracteristicas || '') + '">' + (productoEnEdicion.imagen_caracteristicas || 'Seleccionar...') + '</option>';
                let imagenesEncontradas = 0;
                
                for (const [key, imagenes] of Object.entries(imagenesDisponibles.caracteristicas)) {
                    // Si hay categor√≠a seleccionada, filtrar por ella
                    if (categoriaSeleccionada) {
                        const partes = key.split('/');
                        const categoriaCarpeta = partes[partes.length - 1];
                        const categoriaClave = categoriaCarpeta.split('-').slice(1).join('-').toLowerCase();
                        
                        // Solo incluir si coincide la categor√≠a
                        if (categoriaClave !== categoriaSeleccionada) {
                            continue;
                        }
                    }
                    
                    imagenes.forEach(img => {
                        options += `<option value="${img.url}">${key} - ${img.nombre}</option>`;
                        imagenesEncontradas++;
                    });
                }
                
                console.log(`‚úÖ Modal - Im√°genes de caracter√≠sticas encontradas: ${imagenesEncontradas}`);
                selectCaracteristicas.innerHTML = options;
            }
        }
        
        async function cargarVistaDetalle(modal, producto) {
            let html = '<div style="margin-bottom: 30px;">';
            html += '<div style="position: relative; width: 100%; max-width: 600px; margin: 0 auto; background: #f9fafd; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">';
            
            // Contenedor del slider
            html += '<div id="imagen-slider" style="position: relative; width: 100%; padding-bottom: 100%; background: #f9fafd;">';
            
            // Imagen Listado
            if (producto.imagen_listado && producto.imagen_listado.trim() !== '') {
                html += `<div class="slide" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 1; transition: opacity 0.3s ease;">
                            <img src="${producto.imagen_listado}" style="width: 100%; height: 100%; object-fit: contain; display: block;">
                        </div>`;
            } else {
                html += `<div class="slide" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 1; transition: opacity 0.3s ease; background: #f9fafd; color: #999; font-size: 1em;">Sin imagen de listado</div>`;
            }
            
            // Imagen Caracter√≠sticas
            if (producto.imagen_caracteristicas && producto.imagen_caracteristicas.trim() !== '') {
                html += `<div class="slide" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease;">
                            <img src="${producto.imagen_caracteristicas}" style="width: 100%; height: 100%; object-fit: contain; display: block;">
                        </div>`;
            } else {
                html += `<div class="slide" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; background: #f9fafd; color: #999; font-size: 1em;">Sin imagen de caracter√≠sticas</div>`;
            }
            
            html += '</div>';
            
            // Botones de navegaci√≥n
            html += '<button class="slide-prev" style="position: absolute; top: 50%; left: 15px; transform: translateY(-50%); background: rgba(45, 91, 227, 0.8); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; z-index: 10; transition: background 0.3s ease;">‚Äπ</button>';
            html += '<button class="slide-next" style="position: absolute; top: 50%; right: 15px; transform: translateY(-50%); background: rgba(45, 91, 227, 0.8); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; z-index: 10; transition: background 0.3s ease;">‚Ä∫</button>';
            
            // Indicadores de slide
            html += '<div style="position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 10;">';
            html += '<div class="slide-indicator active" style="width: 10px; height: 10px; border-radius: 50%; background: #2d5be3; cursor: pointer; transition: all 0.3s ease;"></div>';
            html += '<div class="slide-indicator" style="width: 10px; height: 10px; border-radius: 50%; background: rgba(45, 91, 227, 0.4); cursor: pointer; transition: all 0.3s ease;"></div>';
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            
            html += '<div style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #e0e0e0;">';
            html += '<div style="display: flex; gap: 15px; justify-content: center;">';
            html += '<span style="padding: 6px 12px; background: #e6eaff; color: #2d5be3; border-radius: 20px; font-size: 0.9em; font-weight: 600;">üì∏ Imagen Listado</span>';
            html += '<span style="padding: 6px 12px; background: #e6eaff; color: #2d5be3; border-radius: 20px; font-size: 0.9em; font-weight: 600;">üì∏ Imagen Caracter√≠sticas</span>';
            html += '</div>';
            html += '</div>';
            
            html += '<div style="margin-top: 30px; padding-top: 30px; border-top: 1px solid #e0e0e0;">';
            html += `<h4 style="color: #2d5be3; margin-bottom: 15px;">üìã Informaci√≥n del Producto</h4>`;
            html += `<table style="width: 100%; border-collapse: collapse;">
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 10px 0; font-weight: 600; width: 150px;">C√≥digo:</td>
                    <td style="padding: 10px 0;">${producto.codigo}</td>
                </tr>
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 10px 0; font-weight: 600;">Nombre:</td>
                    <td style="padding: 10px 0;">${producto.nombre}</td>
                </tr>
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 10px 0; font-weight: 600;">Precio:</td>
                    <td style="padding: 10px 0; color: #2d5be3; font-weight: 700;">S/. ${producto.precio.toFixed(2)}</td>
                </tr>
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 10px 0; font-weight: 600;">Categor√≠a:</td>
                    <td style="padding: 10px 0;">${producto.categoria}</td>
                </tr>
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 10px 0; font-weight: 600;">Segmento:</td>
                    <td style="padding: 10px 0;">${producto.segmento.toUpperCase()}</td>
                </tr>
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 10px 0; font-weight: 600;">Estado:</td>
                    <td style="padding: 10px 0;">${producto.estado}</td>
                </tr>
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 10px 0; font-weight: 600;">Mes:</td>
                    <td style="padding: 10px 0;">${producto.mes}</td>
                </tr>
                <tr>
                    <td style="padding: 10px 0; font-weight: 600;">Descripci√≥n:</td>
                    <td style="padding: 10px 0;">${producto.descripcion || 'N/A'}</td>
                </tr>
            </table>`;
            html += '</div>';
            
            modal.querySelector('#contenido-detalle').innerHTML = html;
            
            // Inicializar slider
            await new Promise(r => setTimeout(r, 0));
            inicializarSlider(modal);
        }
        
        function inicializarSlider(container) {
            let currentSlide = 0;
            const slides = container.querySelectorAll('.slide');
            const indicators = container.querySelectorAll('.slide-indicator');
            
            const showSlide = (n) => {
                slides.forEach(slide => slide.style.opacity = '0');
                indicators.forEach(ind => ind.classList.remove('active'));
                
                if (n >= slides.length) currentSlide = 0;
                if (n < 0) currentSlide = slides.length - 1;
                
                slides[currentSlide].style.opacity = '1';
                if (indicators[currentSlide]) {
                    indicators[currentSlide].classList.add('active');
                }
            };
            
            const nextSlide = () => {
                currentSlide++;
                showSlide(currentSlide);
            };
            
            const prevSlide = () => {
                currentSlide--;
                showSlide(currentSlide);
            };
            
            // Event listeners para botones de navegaci√≥n
            const prevBtn = container.querySelector('.slide-prev');
            const nextBtn = container.querySelector('.slide-next');
            
            if (prevBtn) prevBtn.addEventListener('click', prevSlide);
            if (nextBtn) nextBtn.addEventListener('click', nextSlide);
            
            // Event listeners para indicadores
            indicators.forEach((indicator, index) => {
                indicator.addEventListener('click', () => {
                    currentSlide = index;
                    showSlide(currentSlide);
                });
            });
            
            // Hover effects
            const buttons = container.querySelectorAll('.slide-prev, .slide-next');
            buttons.forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    btn.style.background = 'rgba(45, 91, 227, 1)';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.background = 'rgba(45, 91, 227, 0.8)';
                });
            });
            
            // Inicializar slide
            showSlide(currentSlide);
        }
        
        async function cargarVistaEdicion(modal, producto) {
            let formHtml = '';
            const campos = ['codigo', 'nombre', 'descripcion', 'precio', 'categoria', 'segmento', 'estado', 'mes', 'ano', 'imagen_listado', 'imagen_caracteristicas'];
            
            formHtml = '<div class="grid">';
            campos.forEach((key) => {
                const value = producto[key];
                const gridSpan = (key === 'descripcion' || key === 'imagen_listado' || key === 'imagen_caracteristicas') ? ' style="grid-column: 1/-1;"' : '';
                
                if (key === 'descripcion' || key === 'imagen_listado' || key === 'imagen_caracteristicas') {
                    if (key === 'imagen_listado') {
                        let optionsListado = '<option value="' + value + '">' + value + '</option>';
                        for (const [loc, imagenes] of Object.entries(imagenesDisponibles.listado)) {
                            imagenes.forEach(img => {
                                optionsListado += '<option value="' + img.url + '">' + loc + ' - ' + img.nombre + '</option>';
                            });
                        }
                        formHtml += '<div class="form-group"' + gridSpan + '><label>' + key + '</label><select name="' + key + '">' + optionsListado + '</select></div>';
                    } else if (key === 'imagen_caracteristicas') {
                        let optionsCarac = '<option value="' + value + '">' + value + '</option>';
                        for (const [loc, imagenes] of Object.entries(imagenesDisponibles.caracteristicas)) {
                            imagenes.forEach(img => {
                                optionsCarac += '<option value="' + img.url + '">' + loc + ' - ' + img.nombre + '</option>';
                            });
                        }
                        formHtml += '<div class="form-group"' + gridSpan + '><label>' + key + '</label><select name="' + key + '">' + optionsCarac + '</select></div>';
                    } else {
                        formHtml += '<div class="form-group"' + gridSpan + '><label>' + key + '</label><textarea name="' + key + '">' + (value || '') + '</textarea></div>';
                    }
                } else if (key === 'categoria') {
                    formHtml += '<div class="form-group"><label>' + key + '</label><select name="' + key + '"><option>' + value + '</option><option>celulares</option><option>laptops</option><option>televisores</option><option>refrigeradoras</option><option>lavadoras</option></select></div>';
                } else if (key === 'segmento') {
                    formHtml += '<div class="form-group"><label>' + key + '</label><select name="' + key + '"><option value="fnb" ' + (value === 'fnb' ? 'selected' : '') + '>FNB</option><option value="gaso" ' + (value === 'gaso' ? 'selected' : '') + '>GASO</option></select></div>';
                } else if (key === 'estado') {
                    formHtml += '<div class="form-group"><label>' + key + '</label><select name="' + key + '"><option value="disponible" ' + (value === 'disponible' ? 'selected' : '') + '>Disponible</option><option value="no disponible" ' + (value === 'no disponible' ? 'selected' : '') + '>No Disponible</option><option value="agotado" ' + (value === 'agotado' ? 'selected' : '') + '>Agotado</option></select></div>';
                } else if (key === 'mes') {
                    const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                    let selectMes = '<div class="form-group"><label>' + key + '</label><select name="' + key + '">';
                    meses.forEach(mes => {
                        selectMes += '<option value="' + mes + '" ' + (value === mes ? 'selected' : '') + '>' + mes.charAt(0).toUpperCase() + mes.slice(1) + '</option>';
                    });
                    selectMes += '</select></div>';
                    formHtml += selectMes;
                } else if (key === 'ano') {
                    let selectAno = '<div class="form-group"><label>' + key + '</label><select name="' + key + '"><option value="2024" ' + (value === 2024 ? 'selected' : '') + '>2024</option><option value="2025" ' + (value === 2025 ? 'selected' : '') + '>2025</option><option value="2026" ' + (value === 2026 ? 'selected' : '') + '>2026</option><option value="2027" ' + (value === 2027 ? 'selected' : '') + '>2027</option></select></div>';
                    formHtml += selectAno;
                } else {
                    const type = key === 'precio' ? 'number' : 'text';
                    const step = key === 'precio' ? ' step="0.01"' : '';
                    formHtml += '<div class="form-group"><label>' + key + '</label><input type="' + type + '" name="' + key + '" value="' + value + '"' + step + '></div>';
                }
            });
            formHtml += '</div>';
            
            formHtml += '<div class="form-group" style="grid-column: 1/-1;"><label>cuotas (JSON)</label><textarea name="cuotas" style="min-height: 150px;">' + JSON.stringify(producto.cuotas, null, 2) + '</textarea></div>';
            
            formHtml += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            formHtml += '<button type="button" id="btn-guardar-edicion" style="flex: 1; padding: 12px;">üíæ Guardar Cambios</button>';
            formHtml += '<button type="button" id="btn-eliminar" class="danger" style="flex: 1; padding: 12px;">üóëÔ∏è Eliminar</button>';
            formHtml += '</div>';
            
            modal.querySelector('#contenido-edicion').innerHTML = formHtml;
            
            // üîß CONFIGURAR LISTENERS PARA CAMBIOS DE SEGMENTO/A√ëO/MES
            const selectSegmentoEdicion = modal.querySelector('select[name="segmento"]');
            const selectAnoEdicion = modal.querySelector('select[name="ano"]');
            const selectMesEdicion = modal.querySelector('select[name="mes"]');
            const selectCategoriaEdicion = modal.querySelector('select[name="categoria"]');
            
            const actualizarImagenesEdicion = async () => {
                const seg = selectSegmentoEdicion ? selectSegmentoEdicion.value : null;
                const an = selectAnoEdicion ? selectAnoEdicion.value : null;
                const m = selectMesEdicion ? selectMesEdicion.value : null;
                
                console.log('üîÑ [MODAL EDICI√ìN] Cambio de filtro seg/a√±o/mes detectado:', { seg, an, m });
                
                // Hacer la request al servidor
                await cargarImagenesDisponibles(seg, an, m);
                
                // Actualizar los dropdowns de im√°genes en el modal
                actualizarSelectImagenesEnModal(modal);
            };
            
            // Agregar listeners a filtros seg/a√±o/mes
            if (selectSegmentoEdicion) selectSegmentoEdicion.addEventListener('change', actualizarImagenesEdicion);
            if (selectAnoEdicion) selectAnoEdicion.addEventListener('change', actualizarImagenesEdicion);
            if (selectMesEdicion) selectMesEdicion.addEventListener('change', actualizarImagenesEdicion);
            
            // Listener SEPARADO para categor√≠a (solo filtra localmente, sin request)
            if (selectCategoriaEdicion) {
                selectCategoriaEdicion.addEventListener('change', () => {
                    console.log('üîÑ [MODAL EDICI√ìN] Categor√≠a cambi√≥, actualizando dropdown...');
                    actualizarSelectImagenesEnModal(modal);
                });
            }
            
            console.log('‚úÖ [MODAL EDICI√ìN] Listeners configurados para cambios de im√°genes');
            
            // Event listeners para los botones
            modal.querySelector('#btn-guardar-edicion').addEventListener('click', async () => {
                await guardarEdicionDesdeModal(modal);
            });
            
            modal.querySelector('#btn-eliminar').addEventListener('click', async () => {
                if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar este producto?')) {
                    await eliminarProducto(producto.id);
                    document.getElementById('detalleModal').remove();
                }
            });
        }
        
        async function guardarEdicionDesdeModal(modal) {
            try {
                const formData = new FormData(modal.querySelector('form') || document.createElement('form'));
                
                // Recopilar datos manualmente del modal
                const data = {
                    codigo: modal.querySelector('input[name="codigo"]')?.value || productoEnEdicion.codigo,
                    nombre: modal.querySelector('input[name="nombre"]')?.value || productoEnEdicion.nombre,
                    descripcion: modal.querySelector('textarea[name="descripcion"]')?.value || productoEnEdicion.descripcion,
                    precio: parseFloat(modal.querySelector('input[name="precio"]')?.value) || productoEnEdicion.precio,
                    categoria: modal.querySelector('select[name="categoria"]')?.value || productoEnEdicion.categoria,
                    imagen_listado: modal.querySelector('select[name="imagen_listado"]')?.value || productoEnEdicion.imagen_listado,
                    imagen_caracteristicas: modal.querySelector('select[name="imagen_caracteristicas"]')?.value || productoEnEdicion.imagen_caracteristicas,
                    cuotas: JSON.parse(modal.querySelector('textarea[name="cuotas"]')?.value || JSON.stringify(productoEnEdicion.cuotas)),
                    mes: modal.querySelector('select[name="mes"]')?.value || productoEnEdicion.mes,
                    ano: parseInt(modal.querySelector('select[name="ano"]')?.value) || productoEnEdicion.ano,
                    segmento: modal.querySelector('select[name="segmento"]')?.value || productoEnEdicion.segmento,
                    estado: modal.querySelector('select[name="estado"]')?.value || productoEnEdicion.estado
                };

                const response = await fetch('/api/productos/' + productoEnEdicion.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    mostrarAlerta('‚úÖ Producto actualizado exitosamente', 'success');
                    document.getElementById('detalleModal').remove();
                    cargarProductos();
                } else {
                    const error = await response.json();
                    mostrarAlerta('‚ùå Error: ' + (error.detail || 'Error desconocido'), 'error');
                }
            } catch(e) {
                mostrarAlerta('‚ùå Error: ' + e.message, 'error');
            }
        }


        function cerrarModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        async function guardarEdicion() {
            try {
                const formData = new FormData(document.getElementById('editForm'));
                const cuotas = JSON.parse(formData.get('cuotas'));
                
                const data = {
                    codigo: formData.get('codigo'),
                    nombre: formData.get('nombre'),
                    descripcion: formData.get('descripcion'),
                    precio: parseFloat(formData.get('precio')),
                    categoria: formData.get('categoria'),
                    imagen_listado: formData.get('imagen_listado'),
                    imagen_caracteristicas: formData.get('imagen_caracteristicas'),
                    cuotas: cuotas,
                    mes: formData.get('mes'),
                    ano: parseInt(formData.get('ano')),
                    segmento: formData.get('segmento'),
                    estado: formData.get('estado')
                };

                const response = await fetch('/api/productos/' + productoEnEdicion.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    mostrarAlerta('‚úÖ Producto actualizado exitosamente', 'success');
                    cerrarModal();
                    cargarProductos();
                } else {
                    const error = await response.json();
                    mostrarAlerta('‚ùå Error: ' + (error.detail || 'Error desconocido'), 'error');
                }
            } catch(e) {
                mostrarAlerta('‚ùå Error: ' + e.message, 'error');
            }
        }

        async function eliminarProducto(id) {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar este producto?')) return;
            
            try {
                const response = await fetch('/api/productos/' + id, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    mostrarAlerta('‚úÖ Producto eliminado exitosamente', 'success');
                    cargarProductos();
                } else {
                    const error = await response.json();
                    mostrarAlerta('‚ùå Error: ' + (error.detail || 'Error desconocido'), 'error');
                }
            } catch(e) {
                mostrarAlerta('‚ùå Error: ' + e.message, 'error');
            }
        }

        function mostrarAlerta(mensaje, tipo) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = 'alert alert-' + tipo;
            alert.textContent = mensaje;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }

        // Cargar im√°genes disponibles al iniciar
        document.addEventListener('DOMContentLoaded', async () => {
            // Cargar con valores por defecto (sin depender de los selects)
            const segmento = 'fnb';
            const ano = '2025';
            const mes = 'noviembre';
            
            console.log('üìå DOMContentLoaded: Cargando con valores por defecto:', { segmento, ano, mes });
            
            // 1. Primero cargar las im√°genes disponibles
            await cargarImagenesDisponibles(segmento, ano, mes);
            
            // 2. Luego inicializar el carrusel y configurar listeners
            inicializarCarruselCrear();
            
            console.log('‚úÖ DOMContentLoaded: Inicializaci√≥n completa');
        });
    </script>
</body>
</html>
